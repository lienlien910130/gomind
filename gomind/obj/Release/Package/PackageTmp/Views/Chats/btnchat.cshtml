@model IdentitySample.Models.ChatIndex

<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" media="screen" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <link rel="stylesheet" href="~/Content/font-awesome.css" />
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap.css" rel="stylesheet" media="screen" />
    <script src="~/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Scripts/jquery-1.10.2.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.5.4/bootstrap-select.min.css" rel="stylesheet" />
    <script src="js/jquery-1.11.3.min.js"></script>
    <script src="~/Scripts/jquery-3.1.0.min.js"></script>
    <script type="text/javascript">
    function OnSuccess(data) {
        $("#message").val("");
    }
    $(document).ready(function () {
        $("#message").html("Waiting for update...");
        var refreshId = setInterval(
            "updateChatArea()",
            1000);
        $('#newmessage_messagebody').keydown(function (e) {
            if (e.keyCode == 13) {
                e.preventDefault();
                $("#newmessage_sendbutton").click();
            }
        });
    });
    function updateChatArea() {
        $.getJSON(
           "/Chats/GetMessages/",
            {id:'@Session["chatid"]' },
            function (data) {
                $("#message").html += "Fetching...";
                $("#chatarea").html("");
                var x;
                if (data.length > 0) {
                    for (x in data) {
                        $("#chatarea").html(
                        $("#chatarea").html() +
                        "<p><b>" +
                        data[x].Username + "</b> <i>(" +
                        data[x].PostDateTime + ")</i> - " +
                        data[x].MessageBody + "</p>");
                    }
                }
                else {
                    $("#chatarea").html("");
                }
            });
        $("#message").html("Messages loaded.");
    }
    function sendNewMessage() {
        $.post(
            "/Chats/AddMessage",
            {
                Id:'@Session["chatid"]' ,
                MessageBody: $("#newmessage_messagebody").val()
            });
        $("#newmessage_messagebody").val("");
        updateChatArea();
    }
    </script>
</head>
<body>
    <h2>Chat</h2>
    <h4 id="message"></h4>
    <div id="chatarea">
    </div>
    <p>
        <input type="hidden" id="newmessage_username" value="SOME USERNAME" />
        Message<br />
        <input type="text" id="newmessage_messagebody" size="70" />
        <input type="button" value="Send" id="newmessage_sendbutton" onclick="sendNewMessage()" />
    </p>
   
    @if (Session["IsUser"].ToString() == "true")
    {
        if (Session["IsOrder"].ToString() == "true")
        {
            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="submit" value="訂單已成立" class="btn btn-default" disabled />
                </div>
            </div>
        }
        else
        {

            @Html.ActionLink("成立訂單", "Create", "Orders", new { id = Model.Chat.ID }, null)
        }

    }
    else
    {
        if (Session["IsOrder"].ToString() == "true")
        {
            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="submit" value="商品已售出" class="btn btn-default" disabled />
                </div>
            </div>
        }
    }

</body>
</html>

@Scripts.Render("~/bundles/jqueryval")
@Scripts.Render("~/bundles/jqueryajax")
